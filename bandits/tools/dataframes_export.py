"""
/*
 * Software Name : Microtune
 * SPDX-FileCopyrightText: Copyright (c) Orange SA
 * SPDX-License-Identifier: MIT
 *
 * This software is distributed under the <license-name>,
 * see the "LICENSE.txt" file for more details or <license-url>
 *
 * <Authors: optional: see CONTRIBUTORS.md
 * Software description: MicroTune is a RL-based DBMS Buffer Pool Auto-Tuning for Optimal and Economical Memory Utilization. Consumed RAM is continously and optimally adjusted in conformance of a SLA constraint (maximum mean latency).
 */
"""
import sys
sys.path.append('.')

from bandits.datasource.dataframes.obs_samples_dataframes import ObsSamplesDF 

picklefiles="./workloads"
version="9"
output_file =f'{picklefiles}_traintest_{version}.csv'

LISTE9=['tables', 'tables_rows', 'wl_clients', 'randtype', 'buf_size', 'db_size_mb', 'observation.innodb_buffer_pool_size', 'observation.normalized_buf_size', 'observation.write_wait_ratio', 'observation.cache_free_pages_ratio', 'observation.cache_used_pages_ratio', 'observation.cache_hit_ratio', 'observation.wl_clients', 'observation.bufsize_incr', 'extra_info.epoch', 'extra_info.step', 'extra_info.bufsize', 'extra_info.terminated', 'extra_info.truncated', 'extra_info.usage.qps', 'extra_info.usage.threads_connected', 'extra_info.usage.created_tmp_disk_tables_per_sec', 'extra_info.usage.db_size_initial.Schema', 'extra_info.usage.db_size_initial.Engine', 'extra_info.usage.db_size_initial.TableSizeMB', 'extra_info.usage.db_size_initial.IndexSizeMB', 'extra_info.global_status.__globvars_collected', 'extra_info.global_status.__complete_globavars_collected', 'extra_info.global_status.Bytes_received_start', 'extra_info.global_status.Bytes_received_end', 'extra_info.global_status.Bytes_received_diff', 'extra_info.global_status.Connections_start', 'extra_info.global_status.Connections_end', 'extra_info.global_status.Connections_diff', 'extra_info.global_status.threads_created_start', 'extra_info.global_status.threads_created_end', 'extra_info.global_status.threads_created_diff', 'extra_info.global_status.threads_running_start', 'extra_info.global_status.threads_running_end', 'extra_info.global_status.threads_running_diff', 'extra_info.global_status.threads_connected_start', 'extra_info.global_status.threads_connected_end', 'extra_info.global_status.threads_connected_diff', 'extra_info.global_status.max_used_connections_start', 'extra_info.global_status.max_used_connections_end', 'extra_info.global_status.max_used_connections_diff', 'extra_info.global_status.aborted_clients_start', 'extra_info.global_status.aborted_clients_end', 'extra_info.global_status.aborted_clients_diff', 'extra_info.global_status.aborted_connects_start', 'extra_info.global_status.aborted_connects_end', 'extra_info.global_status.aborted_connects_diff', 'extra_info.global_status.created_tmp_files_start', 'extra_info.global_status.created_tmp_files_end', 'extra_info.global_status.created_tmp_files_diff', 'extra_info.global_status.created_tmp_tables_start', 'extra_info.global_status.created_tmp_tables_end', 'extra_info.global_status.created_tmp_tables_diff', 'extra_info.global_status.created_tmp_disk_tables_start', 'extra_info.global_status.created_tmp_disk_tables_end', 'extra_info.global_status.created_tmp_disk_tables_diff', 'extra_info.global_status.binlog_cache_disk_use_start', 'extra_info.global_status.binlog_cache_disk_use_end', 'extra_info.global_status.binlog_cache_disk_use_diff', 'extra_info.global_status.binlog_stmt_cache_disk_use_start', 'extra_info.global_status.binlog_stmt_cache_disk_use_end', 'extra_info.global_status.binlog_stmt_cache_disk_use_diff', 'extra_info.global_status.handler_delete_start', 'extra_info.global_status.handler_delete_end', 'extra_info.global_status.handler_delete_diff', 'extra_info.global_status.handler_update_start', 'extra_info.global_status.handler_update_end', 'extra_info.global_status.handler_update_diff', 'extra_info.global_status.handler_write_start', 'extra_info.global_status.handler_write_end', 'extra_info.global_status.handler_write_diff', 'extra_info.global_status.innodb_pages_created_start', 'extra_info.global_status.innodb_pages_created_end', 'extra_info.global_status.innodb_pages_created_diff', 'extra_info.global_status.innodb_pages_read_start', 'extra_info.global_status.innodb_pages_read_end', 'extra_info.global_status.innodb_pages_read_diff', 'extra_info.global_status.innodb_pages_written_start', 'extra_info.global_status.innodb_pages_written_end', 'extra_info.global_status.innodb_pages_written_diff', 'extra_info.global_status.innodb_rows_deleted_start', 'extra_info.global_status.innodb_rows_deleted_end', 'extra_info.global_status.innodb_rows_deleted_diff', 'extra_info.global_status.innodb_rows_inserted_start', 'extra_info.global_status.innodb_rows_inserted_end', 'extra_info.global_status.innodb_rows_inserted_diff', 'extra_info.global_status.innodb_rows_read_start', 'extra_info.global_status.innodb_rows_read_end', 'extra_info.global_status.innodb_rows_read_diff', 'extra_info.global_status.innodb_rows_updated_start', 'extra_info.global_status.innodb_rows_updated_end', 'extra_info.global_status.innodb_rows_updated_diff', 'extra_info.global_status.innodb_row_lock_current_waits_start', 'extra_info.global_status.innodb_row_lock_current_waits_end', 'extra_info.global_status.innodb_row_lock_current_waits_diff', 'extra_info.global_status.innodb_row_lock_time_start', 'extra_info.global_status.innodb_row_lock_time_end', 'extra_info.global_status.innodb_row_lock_time_diff', 'extra_info.global_status.innodb_row_lock_time_avg_start', 'extra_info.global_status.innodb_row_lock_time_avg_end', 'extra_info.global_status.innodb_row_lock_time_avg_diff', 'extra_info.global_status.innodb_row_lock_time_max_start', 'extra_info.global_status.innodb_row_lock_time_max_end', 'extra_info.global_status.innodb_row_lock_time_max_diff', 'extra_info.global_status.innodb_row_lock_waits_start', 'extra_info.global_status.innodb_row_lock_waits_end', 'extra_info.global_status.innodb_row_lock_waits_diff', 'extra_info.global_status.innodb_buffer_pool_bytes_data_start', 'extra_info.global_status.innodb_buffer_pool_bytes_data_end', 'extra_info.global_status.innodb_buffer_pool_bytes_data_diff', 'extra_info.global_status.innodb_buffer_pool_bytes_dirty_start', 'extra_info.global_status.innodb_buffer_pool_bytes_dirty_end', 'extra_info.global_status.innodb_buffer_pool_bytes_dirty_diff', 'extra_info.global_status.innodb_buffer_pool_pages_data_start', 'extra_info.global_status.innodb_buffer_pool_pages_data_end', 'extra_info.global_status.innodb_buffer_pool_pages_data_diff', 'extra_info.global_status.innodb_buffer_pool_pages_total_start', 'extra_info.global_status.innodb_buffer_pool_pages_total_end', 'extra_info.global_status.innodb_buffer_pool_pages_total_diff', 'extra_info.global_status.innodb_buffer_pool_pages_free_start', 'extra_info.global_status.innodb_buffer_pool_pages_free_end', 'extra_info.global_status.innodb_buffer_pool_pages_free_diff', 'extra_info.global_status.innodb_buffer_pool_pages_misc_start', 'extra_info.global_status.innodb_buffer_pool_pages_misc_end', 'extra_info.global_status.innodb_buffer_pool_pages_misc_diff', 'extra_info.global_status.innodb_buffer_pool_reads_start', 'extra_info.global_status.innodb_buffer_pool_reads_end', 'extra_info.global_status.innodb_buffer_pool_reads_diff', 'extra_info.global_status.innodb_buffer_pool_read_requests_start', 'extra_info.global_status.innodb_buffer_pool_read_requests_end', 'extra_info.global_status.innodb_buffer_pool_read_requests_diff', 'extra_info.global_status.innodb_buffer_pool_wait_free_start', 'extra_info.global_status.innodb_buffer_pool_wait_free_end', 'extra_info.global_status.innodb_buffer_pool_wait_free_diff', 'extra_info.global_status.innodb_buffer_pool_write_requests_start', 'extra_info.global_status.innodb_buffer_pool_write_requests_end', 'extra_info.global_status.innodb_buffer_pool_write_requests_diff', 'extra_info.global_status.innodb_data_read_start', 'extra_info.global_status.innodb_data_read_end', 'extra_info.global_status.innodb_data_read_diff', 'extra_info.global_status.innodb_data_reads_start', 'extra_info.global_status.innodb_data_reads_end', 'extra_info.global_status.innodb_data_reads_diff', 'extra_info.global_status.innodb_data_writes_start', 'extra_info.global_status.innodb_data_writes_end', 'extra_info.global_status.innodb_data_writes_diff', 'extra_info.global_status.innodb_data_written_start', 'extra_info.global_status.innodb_data_written_end', 'extra_info.global_status.innodb_data_written_diff', 'extra_info.global_status.__status_collect_obs_duration', 'extra_info.global_status.Questions_start', 'extra_info.global_status.Questions_end', 'extra_info.global_status.Questions_diff', 'extra_info.global_status.Bytes_sent_start', 'extra_info.global_status.Bytes_sent_end', 'extra_info.global_status.Bytes_sent_diff', 'extra_info.global_status.qps', 'extra_info.global_status.Bps', 'extra_info.global_status.KBps', 'extra_info.global_status.created_tmp_disk_tables_per_sec', 'extra_info.global_status.information_schema.innodb_metrics.lock_deadlocks', 'extra_info.global_status.information_schema.innodb_metrics.lock_timeouts', 'extra_info.global_status.information_schema.innodb_metrics.lock_row_lock_current_waits', 'extra_info.global_status.information_schema.innodb_metrics.lock_row_lock_time', 'extra_info.global_status.information_schema.innodb_metrics.lock_row_lock_time_max', 'extra_info.global_status.information_schema.innodb_metrics.lock_row_lock_waits', 'extra_info.global_status.information_schema.innodb_metrics.lock_row_lock_time_avg', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_size', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_reads', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_read_requests', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_write_requests', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_wait_free', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_read_ahead', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_read_ahead_evicted', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_pages_total', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_pages_misc', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_pages_data', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_bytes_data', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_pages_dirty', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_bytes_dirty', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pool_pages_free', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pages_created', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pages_written', 'extra_info.global_status.information_schema.innodb_metrics.buffer_pages_read', 'extra_info.global_status.information_schema.innodb_metrics.buffer_data_reads', 'extra_info.global_status.information_schema.innodb_metrics.buffer_data_written', 'extra_info.global_status.information_schema.innodb_metrics.buffer_LRU_batch_flush_total_pages', 'extra_info.global_status.information_schema.innodb_metrics.buffer_LRU_batch_evict_total_pages', 'extra_info.global_status.information_schema.innodb_metrics.os_data_reads', 'extra_info.global_status.information_schema.innodb_metrics.os_data_writes', 'extra_info.global_status.information_schema.innodb_metrics.os_data_fsyncs', 'extra_info.global_status.information_schema.innodb_metrics.os_pending_reads', 'extra_info.global_status.information_schema.innodb_metrics.os_pending_writes', 'extra_info.global_status.information_schema.innodb_metrics.os_log_bytes_written', 'extra_info.global_status.information_schema.innodb_metrics.trx_rseg_history_len', 'extra_info.global_status.information_schema.innodb_metrics.trx_undo_slots_cached', 'extra_info.global_status.information_schema.innodb_metrics.log_waits', 'extra_info.global_status.information_schema.innodb_metrics.log_write_requests', 'extra_info.global_status.information_schema.innodb_metrics.log_writes', 'extra_info.global_status.information_schema.innodb_metrics.adaptive_hash_searches', 'extra_info.global_status.information_schema.innodb_metrics.adaptive_hash_searches_btree', 'extra_info.global_status.information_schema.innodb_metrics.file_num_open_files', 'extra_info.global_status.information_schema.innodb_metrics.innodb_activity_count', 'extra_info.global_status.information_schema.innodb_metrics.innodb_dblwr_writes', 'extra_info.global_status.information_schema.innodb_metrics.innodb_dblwr_pages_written', 'extra_info.global_status.information_schema.innodb_metrics.innodb_page_size', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.POOL_ID', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.POOL_SIZE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.FREE_BUFFERS', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.DATABASE_PAGES', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.OLD_DATABASE_PAGES', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.MODIFIED_DATABASE_PAGES', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PENDING_DECOMPRESS', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PENDING_READS', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PENDING_FLUSH_LRU', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PENDING_FLUSH_LIST', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_MADE_YOUNG', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_NOT_MADE_YOUNG', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_MADE_YOUNG_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_MADE_NOT_YOUNG_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_PAGES_READ', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_PAGES_CREATED', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_PAGES_WRITTEN', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_READ_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_CREATE_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.PAGES_WRITTEN_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_PAGES_GET', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.HIT_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.YOUNG_MAKE_PER_THOUSAND_GETS', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NOT_YOUNG_MAKE_PER_THOUSAND_GETS', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_PAGES_READ_AHEAD', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.NUMBER_READ_AHEAD_EVICTED', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.READ_AHEAD_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.READ_AHEAD_EVICTED_RATE', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.LRU_IO_TOTAL', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.LRU_IO_CURRENT', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.UNCOMPRESS_TOTAL', 'extra_info.global_status.information_schema.innodb_buffer_pool_stats.UNCOMPRESS_CURRENT', 'extra_info.sysbench.latency', 'extra_info.sysbench.latency_mean', 'extra_info.sysbench.latency_mean_minute', 'extra_info.sysbench.latency_sigma', 'extra_info.sysbench.latency_sigma_minute', 'extra_info.sysbench.statements_mean', 'extra_info.sysbench_local.latency', 'extra_info.sysbench_local.latency_mean', 'extra_info.sysbench_local.latency_mean_minute', 'extra_info.sysbench_local.latency_sigma', 'extra_info.sysbench_local.latency_sigma_minute', 'extra_info.step_completed', 'sysbench_filtered.statements_mean', 'sysbench_filtered.latency_mean', 'buf_size_min_mb', 'buf_values_count', 'buf_size_idx', 'tables_rows_M', 'Rtype', 'combined_column', 'latency_mean_min', 'latency_mean_max', 'qps_mean_min', 'qps_mean_max', 'iqps', 'ilat', 'perf_target_level', 'objective_gap', 'latency_threshold', 'iperf01', 'delta_perf_target01', 'sla_tipping01', 'ARM0_01', 'ARM1_01', 'ARM2_01', 'iperf19', 'delta_perf_target19', 'sla_tipping19', 'ARM0_19', 'ARM1_19', 'ARM2_19']

LISTE=LISTE9
print(f'Initial columns length: {len(LISTE)}')
LISTE = [element for element in LISTE if not (element.endswith('_start') or element.endswith('_diff'))]
LISTE = [element for element in LISTE if not (element.startswith('ARM') or element.endswith('01') or element.endswith('19'))]
LISTE = [element for element in LISTE if not (element.startswith('extra_info.sysbench_local') or element.startswith('sysbench_filtered'))]
print(f'Stage 1: Final columns length: {len(LISTE)}')
columns_to_drop = ["extra_info.epoch", "extra_info.step", "extra_info.terminated", "extra_info.truncated", "extra_info.usage.db_size_initial.Schema",
                   "extra_info.global_status.__globvars_collected", "extra_info.step_completed",
                   "perf_target_level", "objective_gap", "latency_threshold", 'tables_rows_M', 'Rtype',
                ]
LISTE = [element for element in LISTE if element not in (columns_to_drop)]
print(f'Stage 2: Final columns length: {len(LISTE)}')

obsdf = ObsSamplesDF(version=version)
df = obsdf.mergeTrainTest(picklefiles)

df = df[LISTE]
#df = df[columns_to_drop] 
#print(f'Stage 3: Final columns length: {len(df.columns)}')
df.to_csv(output_file, index=False)
